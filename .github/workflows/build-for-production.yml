name: Build for Production

on:
  workflow_call:
    inputs:
      release_tag:
        description: "GitHubリリースのためのオプションのリリース Tag (例: v1.2.3)"
        required: false
        type: string
      pr_number:
        description: "Pull Request Number (if applicable, otherwise 0)"
        required: false
        type: number
        default: 0

jobs:
  build-android-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: '3.29.3' # プロジェクト固有のバージョンを使用
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run build_runner
        run: flutter pub run build_runner build --delete-conflicting-outputs

      # ===== Google Play リリース時にコメントを外して設定 =====
      # 事前に以下のGitHub Secretsを設定する必要があります:
      # - ANDROID_KEYSTORE_BASE64: アップロードキーストア (JKS) の Base64 エンコード文字列
      # - ANDROID_KEYSTORE_PASSWORD: キーストアのパスワード
      # - ANDROID_KEY_ALIAS: キーストア内のキーのエイリアス
      # - ANDROID_KEY_PASSWORD: キーのパスワード
      # =======================================================
      # - name: Setup Android Signing
      #   env:
      #     KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      #     KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      #     KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      #     KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      #   run: |
      #     echo "Setting up Android signing key..."
      #     echo $KEYSTORE_BASE64 | base64 --decode > android/app/upload-keystore.jks
      #     echo "storeFile=../app/upload-keystore.jks" > android/key.properties
      #     echo "storePassword=$KEYSTORE_PASSWORD" >> android/key.properties
      #     echo "keyAlias=$KEY_ALIAS" >> android/key.properties
      #     echo "keyPassword=$KEY_PASSWORD" >> android/key.properties

      # ===== 現在のビルド設定 (リリースモード、署名なし) =====
      # Google Playリリース時は上記 Setup Android Signing を有効化してください。
      # 有効化しない場合、Flutter はデフォルトでデバッグキーを使用して署名します。
      - name: Build Android App Bundle (Release, Unsigned/Debug Key)
        run: flutter build appbundle --release

      # --- App Bundle を ci-outputs へ移動 ---
      - name: Stage Android App Bundle
        run: |
          mkdir -p ./ci-outputs/build/android/bundle/release
          mv build/app/outputs/bundle/release/*.aab ./ci-outputs/build/android/bundle/release/

      - name: Build Android APKs (Release, Unsigned/Debug Key)
        run: flutter build apk --release --split-per-abi
      # =======================================================

      - name: Archive Android Builds (Move APKs)
        run: |
          mkdir -p ./ci-outputs/build/android/apk/release
          mv build/app/outputs/flutter-apk/*-release.apk ./ci-outputs/build/android/apk/release/ || echo "No release APKs found/moved"

      - name: Upload Android App Bundle Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-android-bundle
          path: ./ci-outputs/build/android/bundle/release/*.aab
          retention-days: 7

      - name: Upload Android APKs Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-android-apks
          path: ./ci-outputs/build/android/apk/release/*.apk
          retention-days: 7

  build-ios-release:
    runs-on: macos-latest # iOSビルドにはmacOSが必要
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===== App Store リリース時にコメントを外して設定 =====
      # 事前に以下のGitHub Secretsを設定する必要があります:
      # - BUILD_CERTIFICATE_BASE64: 配布用証明書 (.p12) の Base64 エンコード文字列
      # - P12_PASSWORD: 証明書のパスワード
      # - BUILD_PROVISION_PROFILE_BASE64: 配布用プロビジョニングプロファイル (.mobileprovision) の Base64
      # - KEYCHAIN_PASSWORD: (任意) 一時キーチェーンのパスワード
      # =======================================================
      # - name: Install Apple Certificate and Provisioning Profile
      #   env:
      #     BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      #     P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      #     BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
      #     KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      #   run: |
      #     # 一時キーチェーンを作成
      #     KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
      #     security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
      #     security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
      #     security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
      #     # 証明書をインポート
      #     CERTIFICATE_PATH=$RUNNER_TEMP/dist_certificate.p12
      #     echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
      #     security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
      #     security list-keychain -d user -s $KEYCHAIN_PATH
      #     # プロビジョニングプロファイルをインストール
      #     mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
      #     PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/$(uuidgen).mobileprovision"
      #     echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o "$PROFILE_PATH"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: '3.29.3' # プロジェクト固有のバージョンを使用
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run build_runner
        run: flutter pub run build_runner build --delete-conflicting-outputs

      # ===== 現在のビルド設定 (リリースモード、署名なし) =====
      # App Storeリリース時は上記 Install... Step を有効化し、以下の --no-codesign を削除してください。
      - name: Build iOS IPA (Release, Unsigned)
        run: flutter build ipa --release --no-codesign
      # =======================================================

      # --- IPA を ci-outputs へ移動 ---
      - name: Stage iOS IPA
        run: |
          mkdir -p ./ci-outputs/build/ios/ipa
          mv build/ios/ipa/*.ipa ./ci-outputs/build/ios/ipa/

      - name: Upload iOS IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-ios-ipa
          # パスは通常 `flutter build ipa` の後、build/ios/ipa/*.ipa になる
          path: ./ci-outputs/build/ios/ipa/*.ipa
          retention-days: 7

  create-github-release:
    needs: [build-android-release, build-ios-release]
    runs-on: ubuntu-latest
    if: ${{ inputs.release_tag != '' && success() }}
    permissions:
      contents: write
      actions: read
    steps:
      - name: Download Android Bundle Artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-android-bundle
          path: ./ci-outputs/build/android-bundle

      - name: Download Android APKs Artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-android-apks
          path: ./ci-outputs/build/android-apks

      - name: Download iOS IPA Artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-ios-ipa
          path: ./ci-outputs/build/ios-ipa

      - name: List downloaded artifacts (for debugging)
        run: ls -lR ./ci-outputs/build

      - name: Create GitHub Release Draft
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          name: Release ${{ inputs.release_tag }}
          draft: true
          prerelease: false
          files: |
            ./ci-outputs/build/android-bundle/*
            ./ci-outputs/build/android-apks/*
            ./ci-outputs/build/ios-ipa/*
          token: ${{ secrets.GITHUB_TOKEN }}
          body_path: path/to/release_notes.md